<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.example.mybatislearning.mapper.ProjectMapper">

    <!-- resultMap定義: Projectフィールドのマッピング -->
    <resultMap id="projectResultMap" type="com.example.mybatislearning.entity.Project">
        <id property="id" column="id"/>
        <result property="projectName" column="project_name"/>
        <result property="organizationId" column="organization_id"/>
    </resultMap>

    <!-- resultMapWithAssociation: ProjectとOrganizationの結合マッピング -->
    <resultMap id="projectWithOrganizationResultMap" type="com.example.mybatislearning.entity.Project">
        <id property="id" column="id"/>
        <result property="projectName" column="project_name"/>
        <result property="organizationId" column="organization_id"/>
        <!-- association要素でリレーションシップを定義 -->
        <association property="organization" javaType="com.example.mybatislearning.entity.Organization">
            <id property="id" column="org_id"/>
            <result property="name" column="org_name"/>
            <result property="description" column="org_description"/>
        </association>
    </resultMap>

    <!-- INSERT: useGeneratedKeys="true"でID自動採番 -->
    <insert id="insert" parameterType="com.example.mybatislearning.entity.Project"
            useGeneratedKeys="true" keyProperty="id">
        INSERT INTO projects (project_name, organization_id)
        VALUES (#{projectName}, #{organizationId})
    </insert>

    <!-- SELECT BY ID -->
    <select id="selectById" parameterType="long" resultMap="projectResultMap">
        SELECT id, project_name, organization_id
        FROM projects
        WHERE id = #{id}
    </select>

    <!-- SELECT ALL -->
    <select id="selectAll" resultMap="projectResultMap">
        SELECT id, project_name, organization_id
        FROM projects
    </select>

    <!-- SELECT BY ORGANIZATION ID -->
    <select id="selectByOrganizationId" parameterType="long" resultMap="projectResultMap">
        SELECT id, project_name, organization_id
        FROM projects
        WHERE organization_id = #{organizationId}
    </select>

    <!-- SELECT PROJECT WITH ORGANIZATION: JOINクエリでProjectとOrganizationを取得 -->
    <select id="selectProjectWithOrganization" parameterType="long" resultMap="projectWithOrganizationResultMap">
        SELECT p.id,
               p.project_name,
               p.organization_id,
               o.id          AS org_id,
               o.name        AS org_name,
               o.description AS org_description
        FROM projects p
                 INNER JOIN organizations o ON p.organization_id = o.id
        WHERE p.id = #{id}
    </select>

    <!-- UPDATE -->
    <update id="update" parameterType="com.example.mybatislearning.entity.Project">
        UPDATE projects
        SET project_name = #{projectName},
            organization_id = #{organizationId}
        WHERE id = #{id}
    </update>

    <!-- DELETE BY ID -->
    <delete id="deleteById" parameterType="long">
        DELETE FROM projects
        WHERE id = #{id}
    </delete>

</mapper>
